#!/usr/bin/env bash
set -euo pipefail

# netcup-kube remote bootstrap helper
# - Sets up SSH key access via root@<host> (password from Netcup)
# - Installs sudo + git on the server (apt)
# - Creates a sudo-enabled user and configures authorized_keys
# - Clones this repo and runs the bootstrap as that user (sudo)
#
# Requirements (local): ssh, ssh-copy-id, scp. Optional: sshpass for non-interactive password entry.
#
# Usage examples:
#   bin/netcup-kube-remote root.example.com                   # prompts silently for root password (if sshpass installed), user=cubeadmin
#   bin/netcup-kube-remote 203.0.113.10 --user ops            # prompts silently
#   export ROOT_PASS; read -r -s ROOT_PASS; ./bin/netcup-kube-remote host --user ops  # or pre-set env var
#   bin/netcup-kube-remote host --user ops --pubkey ~/.ssh/id_ed25519.pub
#
# After bootstrap you can SSH as the new user: ssh <user>@<host>

is_tty() { [[ -t 0 && -t 1 ]]; }

install_sshpass() {
  local os
  os="$(uname -s | tr '[:upper:]' '[:lower:]')"

  case "$os" in
    darwin)
      if ! command -v brew > /dev/null 2>&1; then
        echo "Homebrew not found. Install it first, then re-run:" >&2
        echo "  https://brew.sh/" >&2
        return 1
      fi
      echo "Installing sshpass via Homebrew..."
      brew install sshpass
      ;;
    linux)
      if command -v apt-get > /dev/null 2>&1; then
        echo "Installing sshpass via apt-get..."
        sudo apt-get update -y
        sudo apt-get install -y sshpass
      elif command -v dnf > /dev/null 2>&1; then
        echo "Installing sshpass via dnf..."
        sudo dnf install -y sshpass
      elif command -v yum > /dev/null 2>&1; then
        echo "Installing sshpass via yum..."
        sudo yum install -y sshpass
      elif command -v pacman > /dev/null 2>&1; then
        echo "Installing sshpass via pacman..."
        sudo pacman -Sy --noconfirm sshpass
      elif command -v apk > /dev/null 2>&1; then
        echo "Installing sshpass via apk..."
        sudo apk add --no-cache sshpass
      elif command -v zypper > /dev/null 2>&1; then
        echo "Installing sshpass via zypper..."
        sudo zypper --non-interactive install -y sshpass
      else
        echo "No supported package manager found to install sshpass automatically." >&2
        return 1
      fi
      ;;
    *)
      echo "Unsupported OS for auto-install: ${os}" >&2
      return 1
      ;;
  esac
}

maybe_install_sshpass() {
  command -v sshpass > /dev/null 2>&1 && return 0
  is_tty || return 1
  local ans
  read -r -p "sshpass not found. Install now? [y/N]: " ans
  case "${ans:-}" in
    y | Y | yes | YES)
      install_sshpass || return 1
      command -v sshpass > /dev/null 2>&1
      ;;
    *)
      return 1
      ;;
  esac
}

HOST="${1:-}"
if [[ -z "$HOST" ]]; then
  echo "Usage: $(basename "$0") <host-or-ip> [--user <name>] [--pubkey <path>]" >&2
  exit 1
fi

NEW_USER="cubeadmin"
PUBKEY_PATH=""
REPO_URL="https://github.com/mfittko/netcup-kube.git"

# Parse flags
shift || true
while [[ $# -gt 0 ]]; do
  case "$1" in
    --user)
      NEW_USER="${2:-}"
      shift 2 || true
      ;;
    --pubkey)
      PUBKEY_PATH="${2:-}"
      shift 2 || true
      ;;
    --repo)
      REPO_URL="${2:-}"
      shift 2 || true
      ;;
    *)
      echo "Unknown flag: $1" >&2
      exit 1
      ;;
  esac
done

# Pick a public key (prefer ed25519)
default_pubkey=""
for cand in "$PUBKEY_PATH" "$HOME/.ssh/id_ed25519.pub" "$HOME/.ssh/id_rsa.pub"; do
  if [[ -n "$cand" && -f "$cand" ]]; then
    default_pubkey="$cand"
    break
  fi
done
if [[ -z "$default_pubkey" ]]; then
  echo "No public key found. Generate one, e.g.: ssh-keygen -t ed25519 -C '$(whoami)@$(hostname)'" >&2
  exit 1
fi
PUBKEY_PATH="$default_pubkey"
PUBKEY_CONTENT="$(cat "$PUBKEY_PATH")"

# 1) Ensure our key is on root via ssh-copy-id (password auth)
if ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@"$HOST" true 2> /dev/null; then
  echo "SSH key already works for root@$HOST"
else
  if ! command -v sshpass > /dev/null 2>&1; then
    maybe_install_sshpass || true
  fi
  if command -v sshpass > /dev/null 2>&1; then
    if [[ -z "${ROOT_PASS:-}" ]]; then
      read -r -s -p "Root password for root@${HOST}: " ROOT_PASS
      echo
    fi
    echo "Pushing SSH key to root@$HOST with sshpass+ssh-copy-id"
    sshpass -p "$ROOT_PASS" ssh-copy-id -o StrictHostKeyChecking=no -f -i "$PUBKEY_PATH" root@"$HOST"
    unset ROOT_PASS || true
  else
    echo "Passwordless SSH for root not set up yet."
    echo "Install sshpass to allow a silent prompt here, or run:"
    echo "  ssh-copy-id -o StrictHostKeyChecking=no -i '$PUBKEY_PATH' root@$HOST"
    echo "Then re-run this script."
    exit 1
  fi
fi

# 2) Run remote provisioning as root
REMOTE_SCRIPT="$(
  cat << 'EOS'
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y --no-install-recommends sudo git curl ca-certificates

# Create user if missing
if ! id -u __NEW_USER__ >/dev/null 2>&1; then
  adduser --disabled-password --gecos "" __NEW_USER__
fi
usermod -aG sudo __NEW_USER__
install -d -m 0700 -o __NEW_USER__ -g __NEW_USER__ /home/__NEW_USER__/.ssh
# Append key once
awk 'BEGIN{seen=0} $0=="__PUBKEY__"{seen=1} END{exit !seen}' /home/__NEW_USER__/.ssh/authorized_keys 2>/dev/null || \
  echo "__PUBKEY__" >> /home/__NEW_USER__/.ssh/authorized_keys
chown __NEW_USER__:__NEW_USER__ /home/__NEW_USER__/.ssh/authorized_keys
chmod 0600 /home/__NEW_USER__/.ssh/authorized_keys

# Passwordless sudo for the new user (limited to ALL here; adjust if desired)
cat >/etc/sudoers.d/90-__NEW_USER__ <<EOF
__NEW_USER__ ALL=(ALL) NOPASSWD:ALL
EOF
chmod 0440 /etc/sudoers.d/90-__NEW_USER__

# Clone or update netcup-kube
if [[ ! -d /home/__NEW_USER__/netcup-kube ]]; then
  sudo -u __NEW_USER__ git clone __REPO_URL__ /home/__NEW_USER__/netcup-kube
else
  cd /home/__NEW_USER__/netcup-kube && sudo -u __NEW_USER__ git fetch --all -p && sudo -u __NEW_USER__ git pull --ff-only
fi

# Print how to continue
cat <<EOM
[remote] Provisioning complete.
Now run on your local machine:
  ssh __NEW_USER__@__HOST__
Then on the server:
  sudo /home/__NEW_USER__/netcup-kube/bin/netcup-kube bootstrap
EOM
EOS
)"

# Substitute placeholders safely
REMOTE_SCRIPT="${REMOTE_SCRIPT//__NEW_USER__/$NEW_USER}"
REMOTE_SCRIPT="${REMOTE_SCRIPT//__PUBKEY__/$PUBKEY_CONTENT}"
REMOTE_SCRIPT="${REMOTE_SCRIPT//__REPO_URL__/$REPO_URL}"
REMOTE_SCRIPT="${REMOTE_SCRIPT//__HOST__/$HOST}"

ssh -o StrictHostKeyChecking=no root@"$HOST" "bash -s" <<< "$REMOTE_SCRIPT"
