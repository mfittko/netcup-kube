#!/usr/bin/env bash
set -euo pipefail

# netcup-kube-install: dispatcher for recipe install scripts
# Usage: netcup-kube-install <recipe> [options]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${SCRIPT_DIR%/bin}"
RECIPES_DIR="${PROJECT_ROOT}/scripts/recipes"
CONFIG_DIR="${PROJECT_ROOT}/config"
LOCAL_KUBECONFIG="${CONFIG_DIR}/k3s.yaml"

ctl_socket() {
  local user="$1" host="$2" local_port="$3"
  local base="${XDG_RUNTIME_DIR:-/tmp}"
  local key="${user}@${host}-${local_port}"
  key="${key//@/_}"
  key="${key//:/_}"
  key="${key//\//_}"
  echo "${base%/}/netcup-kube-tunnel-${key}.ctl"
}

is_tunnel_running() {
  local host="$1" user="$2" local_port="$3"
  local sock
  sock="$(ctl_socket "$user" "$host" "$local_port")"
  ssh -S "$sock" -O check "${user}@${host}" > /dev/null 2>&1
}

usage() {
  cat << 'EOF'
Install optional components and tools onto the k3s cluster.

Usage:
  netcup-kube-install <recipe> [recipe-options]

Available recipes:
  argo-cd                  Install Argo CD (GitOps continuous delivery tool)
  postgres                 Install PostgreSQL (Bitnami Helm chart)
  redis                    Install Redis (Bitnami Helm chart)
  sealed-secrets           Install Sealed Secrets (encrypt secrets for Git)
  redisinsight             Install RedisInsight (Redis GUI)
  kube-prometheus-stack    Install Grafana + Prometheus + Alertmanager
  dashboard                Install Kubernetes Dashboard (official web UI)

Examples:
  netcup-kube-install argo-cd --help
  netcup-kube-install argo-cd --host cd.example.com

Notes:
  - Recipes are installed on the cluster, not the host OS.
  - If KUBECONFIG is not set and you are not on the server, this will fetch
    /etc/rancher/k3s/k3s.yaml from the management node via scp.
EOF
}

if [[ $# -lt 1 || "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  usage
  exit 0
fi

RECIPE="$1"
shift || true

RECIPE_SCRIPT="${RECIPES_DIR}/${RECIPE}/install.sh"

if [[ ! -f "${RECIPE_SCRIPT}" ]]; then
  echo "Unknown recipe: ${RECIPE}" >&2
  echo "Run 'netcup-kube-install --help' to see available recipes." >&2
  exit 1
fi

if [[ ! -x "${RECIPE_SCRIPT}" ]]; then
  chmod +x "${RECIPE_SCRIPT}"
fi

# Parse --host flag for automatic domain management
HOST_ARG=""
for arg in "$@"; do
  case "$arg" in
    --host=*)
      HOST_ARG="${arg#*=}"
      ;;
    --host)
      # Next arg should be the host value, but we'll let the recipe handle validation
      HOST_ARG="__NEXT__"
      ;;
  esac
  if [[ "${HOST_ARG}" == "__NEXT__" && "$arg" != "--host" ]]; then
    HOST_ARG="$arg"
    break
  fi
done

# Ensure kubeconfig is available
if [[ -z "${KUBECONFIG:-}" ]]; then
  # If on the server, recipes will fall back to /etc/rancher/k3s/k3s.yaml
  if [[ ! -f "/etc/rancher/k3s/k3s.yaml" ]]; then
    # Not on server; fetch from remote if not already cached locally
    if [[ ! -f "${LOCAL_KUBECONFIG}" ]]; then
      echo "KUBECONFIG not set and local kubeconfig not found. Fetching from remote..."

      # Source env to get MGMT_HOST/MGMT_USER
      ENV_FILE="${CONFIG_DIR}/netcup-kube.env"
      if [[ ! -f "${ENV_FILE}" ]]; then
        echo "ERROR: ${ENV_FILE} not found. Please create it from the example." >&2
        exit 1
      fi

      # shellcheck disable=SC1090
      source "${ENV_FILE}"

      REMOTE_HOST="${MGMT_HOST:-}"
      REMOTE_USER="${MGMT_USER:-ops}"

      if [[ -z "${REMOTE_HOST}" ]]; then
        echo "ERROR: MGMT_HOST not set in ${ENV_FILE}" >&2
        exit 1
      fi

      mkdir -p "${CONFIG_DIR}"
      echo "Fetching kubeconfig from ${REMOTE_USER}@${REMOTE_HOST}:/etc/rancher/k3s/k3s.yaml"
      scp "${REMOTE_USER}@${REMOTE_HOST}:/etc/rancher/k3s/k3s.yaml" "${LOCAL_KUBECONFIG}"

      echo "Kubeconfig saved to ${LOCAL_KUBECONFIG}"
    fi

    export KUBECONFIG="${LOCAL_KUBECONFIG}"

    # Check if tunnel is needed and running
    # The kubeconfig uses 127.0.0.1:6443, which requires an active SSH tunnel
    # Source env to get REMOTE_HOST if not already sourced
    if [[ -z "${REMOTE_HOST:-}" ]]; then
      ENV_FILE="${CONFIG_DIR}/netcup-kube.env"
      # shellcheck disable=SC1090
      source "${ENV_FILE}"
      REMOTE_HOST="${MGMT_HOST:-}"
      REMOTE_USER="${MGMT_USER:-ops}"
    fi

    if [[ -n "${REMOTE_HOST:-}" && -n "${REMOTE_USER:-}" ]]; then
      TUNNEL_PORT="${TUNNEL_LOCAL_PORT:-6443}"
      if ! is_tunnel_running "${REMOTE_HOST}" "${REMOTE_USER}" "${TUNNEL_PORT}"; then
        echo "SSH tunnel not running. Starting tunnel..."
        TUNNEL_SCRIPT="${SCRIPT_DIR}/netcup-kube-tunnel"
        if [[ ! -x "${TUNNEL_SCRIPT}" ]]; then
          echo "ERROR: netcup-kube-tunnel script not found at ${TUNNEL_SCRIPT}" >&2
          exit 1
        fi
        "${TUNNEL_SCRIPT}" start
        # Give tunnel a moment to establish
        sleep 1
        # Verify tunnel is now running
        if ! is_tunnel_running "${REMOTE_HOST}" "${REMOTE_USER}" "${TUNNEL_PORT}"; then
          echo "ERROR: Failed to start SSH tunnel" >&2
          exit 1
        fi
      fi
      echo "Using tunnel: localhost:${TUNNEL_PORT} -> ${REMOTE_HOST}:6443"
    fi
  fi
fi

# Run the recipe (don't use exec so we can handle post-install steps)
"${RECIPE_SCRIPT}" "$@"
RECIPE_EXIT_CODE=$?

# If recipe succeeded and --host was specified, auto-add domain to Caddy
if [[ ${RECIPE_EXIT_CODE} -eq 0 && -n "${HOST_ARG}" && "${HOST_ARG}" != "__NEXT__" ]]; then
  # Only do this when running locally (not on the server)
  if [[ ! -f "/etc/caddy/Caddyfile" ]]; then
    REMOTE_WRAPPER="${PROJECT_ROOT}/bin/netcup-kube-remote"
    if [[ -x "${REMOTE_WRAPPER}" ]]; then
      echo ""
      echo "Adding ${HOST_ARG} to Caddy edge-http domains..."
      if "${REMOTE_WRAPPER}" run dns --type edge-http --add-domains "${HOST_ARG}"; then
        echo "✓ Domain added successfully!"
      else
        echo "⚠ Failed to add domain automatically. Run manually:"
        echo "  bin/netcup-kube-remote run dns --type edge-http --add-domains \"${HOST_ARG}\""
      fi
    fi
  fi
fi

exit ${RECIPE_EXIT_CODE}
