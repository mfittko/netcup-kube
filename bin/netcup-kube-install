#!/usr/bin/env bash
set -euo pipefail

# netcup-kube-install: dispatcher for recipe install scripts
# Usage: netcup-kube-install <recipe> [options]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${SCRIPT_DIR%/bin}"
RECIPES_DIR="${PROJECT_ROOT}/scripts/recipes"
CONFIG_DIR="${PROJECT_ROOT}/config"
LOCAL_KUBECONFIG="${CONFIG_DIR}/k3s.yaml"

ctl_socket() {
  local user="$1" host="$2" local_port="$3"
  local base="${XDG_RUNTIME_DIR:-/tmp}"
  local key="${user}@${host}-${local_port}"
  key="${key//@/_}"
  key="${key//:/_}"
  key="${key//\//_}"
  echo "${base%/}/netcup-kube-tunnel-${key}.ctl"
}

is_tunnel_running() {
  local host="$1" user="$2" local_port="$3"
  local sock
  sock="$(ctl_socket "$user" "$host" "$local_port")"
  ssh -S "$sock" -O check "${user}@${host}" > /dev/null 2>&1
}

usage() {
  cat << 'EOF'
Install optional components and tools onto the k3s cluster.

Usage:
  netcup-kube-install <recipe> [recipe-options]

Available recipes:
  argo-cd    Install Argo CD (GitOps continuous delivery tool)

Examples:
  netcup-kube-install argo-cd --help
  netcup-kube-install argo-cd --host cd.example.com

Notes:
  - Recipes are installed on the cluster, not the host OS.
  - If KUBECONFIG is not set and you are not on the server, this will fetch
    /etc/rancher/k3s/k3s.yaml from the management node via scp.
EOF
}

if [[ $# -lt 1 || "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  usage
  exit 0
fi

RECIPE="$1"
shift || true

RECIPE_SCRIPT="${RECIPES_DIR}/${RECIPE}/install.sh"

if [[ ! -f "${RECIPE_SCRIPT}" ]]; then
  echo "Unknown recipe: ${RECIPE}" >&2
  echo "Run 'netcup-kube-install --help' to see available recipes." >&2
  exit 1
fi

if [[ ! -x "${RECIPE_SCRIPT}" ]]; then
  chmod +x "${RECIPE_SCRIPT}"
fi

# Ensure kubeconfig is available
if [[ -z "${KUBECONFIG:-}" ]]; then
  # If on the server, recipes will fall back to /etc/rancher/k3s/k3s.yaml
  if [[ ! -f "/etc/rancher/k3s/k3s.yaml" ]]; then
    # Not on server; fetch from remote if not already cached locally
    if [[ ! -f "${LOCAL_KUBECONFIG}" ]]; then
      echo "KUBECONFIG not set and local kubeconfig not found. Fetching from remote..."

      # Source env to get MGMT_HOST/MGMT_USER
      ENV_FILE="${CONFIG_DIR}/netcup-kube.env"
      if [[ ! -f "${ENV_FILE}" ]]; then
        echo "ERROR: ${ENV_FILE} not found. Please create it from the example." >&2
        exit 1
      fi

      # shellcheck disable=SC1090
      source "${ENV_FILE}"

      REMOTE_HOST="${MGMT_HOST:-}"
      REMOTE_USER="${MGMT_USER:-ops}"

      if [[ -z "${REMOTE_HOST}" ]]; then
        echo "ERROR: MGMT_HOST not set in ${ENV_FILE}" >&2
        exit 1
      fi

      mkdir -p "${CONFIG_DIR}"
      echo "Fetching kubeconfig from ${REMOTE_USER}@${REMOTE_HOST}:/etc/rancher/k3s/k3s.yaml"
      scp "${REMOTE_USER}@${REMOTE_HOST}:/etc/rancher/k3s/k3s.yaml" "${LOCAL_KUBECONFIG}"

      echo "Kubeconfig saved to ${LOCAL_KUBECONFIG}"
    fi

    export KUBECONFIG="${LOCAL_KUBECONFIG}"

    # Check if tunnel is needed and running
    # The kubeconfig uses 127.0.0.1:6443, which requires an active SSH tunnel
    # Source env to get REMOTE_HOST if not already sourced
    if [[ -z "${REMOTE_HOST:-}" ]]; then
      ENV_FILE="${CONFIG_DIR}/netcup-kube.env"
      # shellcheck disable=SC1090
      source "${ENV_FILE}"
      REMOTE_HOST="${MGMT_HOST:-}"
      REMOTE_USER="${MGMT_USER:-ops}"
    fi

    if [[ -n "${REMOTE_HOST:-}" && -n "${REMOTE_USER:-}" ]]; then
      TUNNEL_PORT="${TUNNEL_LOCAL_PORT:-6443}"
      if ! is_tunnel_running "${REMOTE_HOST}" "${REMOTE_USER}" "${TUNNEL_PORT}"; then
        echo ""
        echo "ERROR: kubectl cannot connect without an SSH tunnel" >&2
        echo "" >&2
        echo "Start the tunnel first:" >&2
        echo "  bin/netcup-kube-tunnel start" >&2
        echo "" >&2
        echo "Then retry this command." >&2
        echo "" >&2
        exit 1
      fi
      echo "Using tunnel: localhost:${TUNNEL_PORT} -> ${REMOTE_HOST}:6443"
    fi
  fi
fi

exec "${RECIPE_SCRIPT}" "$@"
